<!---
Copyright Â© 2015-2018 the contributors (see Contributors.md).

This file is part of Knora.

Knora is free software: you can redistribute it and/or modify
it under the terms of the GNU Affero General Public License as published
by the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

Knora is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public
License along with Knora.  If not, see <http://www.gnu.org/licenses/>.
-->

# Gravsearch Responder Logic

@@toc

## Transformation of a Gravsearch Query

A Gravsearch query submitted by the client is parsed by `GravsearchParser` and preprocessed by `GravsearchTypeInspector` 
to get type information about the elements used in the query (resources, values, properties etc.) 
and do some basic sanity checks.

In `SearchResponderV2`, two queries are generated from the Gravsearch query: a prequery and a main query. 
The two queries are generated by transforming the Gravsearch query.

### Gravsearch Type Inspection

### Query Transformers

The Gravsearch query is passed to `QueryTraverser` along with a query transformer. Query transformers are classes 
that implement traits supported by `QueryTraverser`:

-  `WhereTransformer`: instructions how to convert statements in the Where clause of SPARQL query (to generate the prequery's Where clause).
- `ConstructToSelectTransformer` (extends `WhereTransformer`): instructions how to turn a Construct query into a Select query (convert Gravsearch query into prequery)
- `SelectToSelectTransformer` (extends `WhereTransformer`): instructions how to turn a triplestore independent Select query into a triplestore dependent Select query (implementation of inference).    
- `ConstructToConstructTransformer` (extends `WhereTransformer`): instructions how to turn a triplestore independent Construct query into a triplestore dependent Construct query (implementation of inference).

The traits mentioned above define methods that are called by `QueryTraverser` on the transformers provided to perform SPAQRL to SPARQL conversions. This is necessary because Gravsearch has to be turned into 
SPARQL that is sent to the triplestore. This SPARQL is more complex.

### Prequery

The purpose of the prequery is to get an ordered collection of results. Sort criteria can be submitted by the user, but the result is always deterministic also without sort criteria.
Also paging is supported. A prequery is a SPARQL SELECT query.

If the client submits a count query, the prrequery returns the overall number of hits, but not the results themselves.

In a first step, the Gravsearch query's WHERE clause is transformed and the prequery is generated from this result. 
The transformation of the Gravsearch query's WHERE clause relies on an implementation of the abstract class `AbstractSparqlTransformer` 
that goes through the statements one by one and transforms them if necessary.

Gravsearch data and count prequeries' `ConstructToSelectTransformer` classes are both based on an abstract class `AbstractSparqlTransformer` 
that extends `WhereTransformer`. 

The `AbstractSparqlTransformer` contains members that need some explanation:
-  `mainResourceVariable: Option[QueryVariable]`: the variable the represents the main resource
- `dependentResourceVariables: mutable.Set[QueryVariable]`: a set of variables representing dependent resources used in the Gravsearch query provided by the user. These are also used in the prequery's WHERE clause and need to be registered to obtain the Iris contained in the prequery's result (SELECT clause).
- `dependentResourceVariablesGroupConcat: Set[QueryVariable]`: contains the Iris of dependent resources as a string using a special separator represented as query variables in the Gravsearch query.
- `valueObjectVariables: mutable.Set[QueryVariable]`: a set of variables representing values (value objects) used in the Gravsearch query provided by the user. These are also used in the prequery's WHERE clause and need to be registered to obtain the Iris contained in the prequery's result (SELECT clause).
- `valueObjectVarsGroupConcat: Set[QueryVariable]`: contains the Iris of value objects as a string using a special separator  that matched the given search criteria.

### Main Query